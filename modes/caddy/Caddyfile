{
    # Global options
    email {$LETSENCRYPT_EMAIL}

    # Security headers for all sites
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        # XSS protection
        X-Frame-Options "SAMEORIGIN"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Remove server header
        -Server
    }
}

# Main domain with dashboard
{$CLOUDFLARE_DOMAIN} {
    # Simple dashboard/landing page
    respond <<HTML
    <!DOCTYPE html>
    <html>
    <head>
        <title>Stack AI Local</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
            .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            h1 { color: #333; text-align: center; }
            .services { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }
            .service { padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center; transition: transform 0.2s; }
            .service:hover { transform: translateY(-2px); }
            .service a { text-decoration: none; color: #007bff; font-weight: bold; }
            .service p { margin: 10px 0 0 0; color: #666; font-size: 14px; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üöÄ Stack AI Local - Modo Caddy</h1>
            <div class="services">
                <div class="service">
                    <a href="/n8n">üß† n8n</a>
                    <p>Automatizaci√≥n y workflows</p>
                </div>
                <div class="service">
                    <a href="/openwebui">üí¨ Open WebUI</a>
                    <p>Interfaz de chat AI</p>
                </div>
                <div class="service">
                    <a href="/flowise">üîó Flowise</a>
                    <p>Constructor de agentes AI</p>
                </div>
                <div class="service">
                    <a href="/qdrant">üîç Qdrant</a>
                    <p>Base de datos vectorial</p>
                </div>
                <div class="service">
                    <a href="/supabase">üóÑÔ∏è Supabase</a>
                    <p>Backend as a Service</p>
                </div>
                <div class="service">
                    <a href="/searxng">üîé SearXNG</a>
                    <p>Motor de b√∫squeda privado</p>
                </div>
            </div>
        </div>
    </body>
    </html>
    HTML 200

    # Service routes
    handle_path /n8n* {
        reverse_proxy n8n:5678 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    handle_path /openwebui* {
        reverse_proxy open-webui:8080 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    handle_path /flowise* {
        reverse_proxy flowise:3001 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    handle_path /qdrant* {
        reverse_proxy qdrant:6333 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    handle_path /supabase* {
        reverse_proxy supabase_auth:3000 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    handle_path /searxng* {
        reverse_proxy searxng:8080 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Compression for better performance
    encode gzip

    # Logging
    log {
        output file /var/log/caddy/access.log
        level INFO
    }
}