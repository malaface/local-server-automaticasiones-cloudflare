# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a local AI stack deployment system organized by deployment modes for maximum simplicity. Each mode is self-contained in its own folder with specific documentation, configuration, and scripts.

## New Structure (Simplified)

The project is now organized into three main modes:

### Quick Mode Access
```bash
# Choose your mode and go to its folder:
cd modes/local/      # For local development
cd modes/caddy/      # For server with domain
cd modes/cloudflare/ # For remote access

# Each mode has a simple start script:
./start.sh           # One command setup!
```

### Legacy Commands (Still Available)
```bash
# Original commands still work for compatibility:
python3 start_services.py --mode local
python3 start_services.py --mode caddy
python3 start_services.py --mode cloudflare
```

### Service Management
```bash
# View running containers
docker ps

# View logs
docker logs -f n8n
docker logs -f open-webui
docker logs -f flowise

# Stop all services
docker compose -p localai down

# Stop and remove volumes (DESTRUCTIVE)
docker compose -p localai down -v

# View service status and resource usage
docker stats
```

### Container Updates
```bash
# Automated update (recommended)
./update.sh

# Manual update by mode
# LOCAL MODE:
docker compose -p localai -f docker-compose.yml down
docker compose -p localai -f docker-compose.yml pull
python3 start_services.py --mode local

# CADDY MODE:
docker compose -p localai -f docker-compose.yml --profile caddy down
docker compose -p localai -f docker-compose.yml --profile caddy pull
python3 start_services.py --mode caddy

# CLOUDFLARE MODE:
docker compose -p localai -f docker-compose.yml --profile cloudflare down
docker compose -p localai -f docker-compose.yml --profile cloudflare pull
python3 start_services.py --mode cloudflare

# FULL MODE:
docker compose -p localai -f docker-compose.yml --profile caddy --profile cloudflare down
docker compose -p localai -f docker-compose.yml --profile caddy --profile cloudflare pull
python3 start_services.py --mode full

# Update specific services only
docker compose -p localai pull n8n open-webui flowise

# Clean up old images
docker image prune -f
```

### Diagnostics
```bash
# Check ports
netstat -tlnp | grep -E ":(3000|3001|5678|6333|8000|8080|80|443)"

# View all stack logs
docker compose -p localai logs -f
```

## New Architecture (Organized by Modes)

### Folder Structure
```
modes/
â”œâ”€â”€ local/           # Local development mode
â”‚   â”œâ”€â”€ README.md    # Simple 30-line guide
â”‚   â”œâ”€â”€ start.sh     # One-command setup
â”‚   â”œâ”€â”€ .env.example # Local-specific variables
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ caddy/           # Server with domain mode
â”‚   â”œâ”€â”€ README.md    # SSL/domain guide
â”‚   â”œâ”€â”€ start.sh     # Domain setup script
â”‚   â”œâ”€â”€ Caddyfile    # Reverse proxy config
â”‚   â””â”€â”€ docker-compose.yml
â””â”€â”€ cloudflare/      # Remote access mode
    â”œâ”€â”€ README.md    # Tunnel setup guide
    â”œâ”€â”€ start.sh     # Tunnel setup script
    â”œâ”€â”€ config.yml   # Tunnel configuration
    â””â”€â”€ docker-compose.yml

shared/              # Common components
â”œâ”€â”€ docker-compose.base.yml  # Base services
â””â”€â”€ scripts/         # Shared scripts
```

### Deployment Modes
- **modes/local/**: Direct port access (localhost:port)
- **modes/caddy/**: SSL with domain (https://ai.domain.com/service)
- **modes/cloudflare/**: Tunnel access (no open ports needed)

### Core Services (Same in All Modes)
- **n8n** (5678): Workflow automation
- **Open WebUI** (3000): AI chat interface
- **Flowise** (3001): AI agent builder
- **Qdrant** (6333): Vector database
- **Supabase** (8000): Backend service
- **SearXNG** (8080): Private search

### Key Benefits of New Structure
- **Simplicity**: Each mode has 20-30 line README
- **Self-contained**: All files needed in one folder
- **One-command setup**: `./start.sh` does everything
- **Mode-specific configs**: No complex overrides needed

## Environment Setup

### Required Variables (All Modes)
```bash
# Critical variables (auto-generated by setup.sh)
POSTGRES_PASSWORD=secure_password
JWT_SECRET=64_char_secure_secret
SECRET_KEY_BASE=64_char_secure_base
DOCKER_SOCKET_LOCATION=/var/run/docker.sock

# API keys (user must provide)
OPENAI_API_KEY=sk-your_key
ANTHROPIC_API_KEY=sk-ant-your_key

# Additional required variables
N8N_ENCRYPTION_KEY=32_char_encryption_key
ANON_KEY=64_char_anonymous_key
SERVICE_ROLE_KEY=64_char_service_key
VAULT_ENC_KEY=32_char_vault_key
```

### Caddy Mode Additional
```bash
CLOUDFLARE_DOMAIN=yourdomain.com
LETSENCRYPT_EMAIL=your@email.com
```

### Cloudflare Mode Additional
```bash
TUNNEL_TOKEN=your_cloudflare_tunnel_token
```

## Development Workflow (New Simplified Process)

### Quick Start for Any Mode
1. **Choose mode**: Go to `modes/local/`, `modes/caddy/`, or `modes/cloudflare/`
2. **Read README**: Each has a focused 20-30 line guide
3. **Run script**: Execute `./start.sh` - it handles everything
4. **Access services**: URLs shown after successful start

### Migration Path
1. **Start Local**: Begin with `modes/local/` for learning
2. **Add Domain**: Move to `modes/caddy/` when ready for SSL
3. **Remote Access**: Use `modes/cloudflare/` for external access

### Legacy Support
- Original `start_services.py` still works for advanced users
- All existing documentation preserved in original README
- Backward compatibility maintained

## Recent Major Improvement: Mode-Based Organization

### New Features (v2.0)
- ðŸ†• **Mode-based folders**: Each deployment mode in separate folder
- ðŸ†• **Simplified READMEs**: 20-30 lines instead of 1000+
- ðŸ†• **One-command setup**: `./start.sh` handles everything per mode
- ðŸ†• **Self-contained configs**: No complex overrides needed
- ðŸ†• **Shared components**: Common services in `shared/` folder

### Benefits
- **Reduced complexity**: Users only see what they need
- **Faster onboarding**: 5 minutes instead of 30+ minutes reading
- **Mode-specific optimization**: Each mode has tailored configuration
- **Easier maintenance**: Changes isolated to specific modes

## Important Notes

- All services use the unified project name "localai" for Docker Compose
- Supabase is started first, followed by other services with a 10-second delay
- Each mode's `start.sh` script handles secret generation automatically
- Path-based routing used for simplicity (ai.domain.com/service)
- **New**: Mode isolation prevents configuration conflicts
- **New**: Each mode is fully self-contained and portable
- Legacy commands maintained for backward compatibility