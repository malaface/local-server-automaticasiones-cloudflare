# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a local AI stack deployment system with multiple deployment modes, based on Docker Compose orchestration. The project provides a complete AI infrastructure including n8n workflows, Open WebUI chat interface, Flowise AI agents, vector databases, and more.

## Core Commands

### Quick Setup for Remote Servers
```bash
# Automated setup (recommended for remote servers/PuTTY)
./setup.sh

# Manual validation only
python3 start_services.py --validate-only
```

### Starting Services
```bash
# Local development mode (default)
python3 start_services.py --mode local

# Production modes
python3 start_services.py --mode caddy    # SSL with Let's Encrypt
python3 start_services.py --mode cloudflare  # Cloudflare Tunnel
python3 start_services.py --mode full    # Both Caddy + Cloudflare

# With specific environment
python3 start_services.py --mode local --environment public
```

### Service Management
```bash
# View running containers
docker ps

# View logs
docker logs -f n8n
docker logs -f open-webui
docker logs -f flowise

# Stop all services
docker compose -p localai down

# Stop and remove volumes (DESTRUCTIVE)
docker compose -p localai down -v

# View service status and resource usage
docker stats
```

### Diagnostics
```bash
# Check ports
netstat -tlnp | grep -E ":(3000|3001|5678|6333|8000|8080|80|443)"

# View all stack logs
docker compose -p localai logs -f
```

## Architecture

### Deployment Modes
- **local**: Direct port access (localhost:port)
- **caddy**: Reverse proxy with automatic SSL (https://service.domain.com)
- **cloudflare**: Cloudflare Tunnel access (no open ports required)
- **full**: Combined Caddy + Cloudflare for maximum flexibility

### Core Services
- **n8n** (port 5678): Workflow automation platform
- **Open WebUI** (port 3000): Modern chat interface for AI models
- **Flowise** (port 3001): Visual AI agent builder
- **Qdrant** (port 6333): Vector database for RAG applications
- **Supabase** (port 8000): Backend-as-a-Service with PostgreSQL
- **SearXNG** (port 8080): Private search engine
- **PostgreSQL** (port 5432): Primary database (internal)
- **Redis/Valkey** (port 6379): Caching and message queue (internal)

### Configuration Structure
- `docker-compose.yml`: Base service definitions
- `docker-compose.override.*.yml`: Mode-specific overrides
- `docker-compose.override.public.supabase.yml`: **Fixed missing file**
- `.env`: Environment configuration (copy from `.env.example`)
- `start_services.py`: Main orchestration script with enhanced validation
- `setup.sh`: Automated setup script for remote servers
- `Caddyfile`: Reverse proxy configuration
- `cloudflare/config.yml`: Cloudflare Tunnel configuration

### Key Files
- `setup.sh`: **New automated setup script** for remote servers/PuTTY users
- `start_services.py`: Enhanced with validation and error handling
- `.env.example`: Updated with all required variables
- `README.md`: Comprehensive setup and usage guide
- `INSTALL.md`: Updated with remote server specific instructions

## Environment Setup

### Required Variables (All Modes)
```bash
# Critical variables (auto-generated by setup.sh)
POSTGRES_PASSWORD=secure_password
JWT_SECRET=64_char_secure_secret
SECRET_KEY_BASE=64_char_secure_base
DOCKER_SOCKET_LOCATION=/var/run/docker.sock

# API keys (user must provide)
OPENAI_API_KEY=sk-your_key
ANTHROPIC_API_KEY=sk-ant-your_key

# Additional required variables
N8N_ENCRYPTION_KEY=32_char_encryption_key
ANON_KEY=64_char_anonymous_key
SERVICE_ROLE_KEY=64_char_service_key
VAULT_ENC_KEY=32_char_vault_key
```

### Caddy Mode Additional
```bash
CLOUDFLARE_DOMAIN=yourdomain.com
LETSENCRYPT_EMAIL=your@email.com
```

### Cloudflare Mode Additional
```bash
TUNNEL_TOKEN=your_cloudflare_tunnel_token
```

## Development Workflow

### For Remote Servers (Recommended)
1. **Quick Setup**: Run `./setup.sh` - handles everything automatically
2. **Manual Setup**: Follow INSTALL.md remote server section
3. **Validation**: Use `python3 start_services.py --validate-only` before starting
4. **Access**: Use server IP instead of localhost for remote access

### For Local Development
1. **Setup**: Copy `.env.example` to `.env` and configure required variables
2. **Development**: Start with `--mode local` for development
3. **Testing**: Use `--mode caddy` to test SSL and domain setup
4. **Production**: Deploy with `--mode cloudflare` or `--mode full`

## Recent Fixes and Improvements

### Fixed Issues
- âœ… **Missing file**: `docker-compose.override.public.supabase.yml` created
- âœ… **Docker socket error**: `DOCKER_SOCKET_LOCATION` variable added
- âœ… **Environment variables**: All required Supabase variables added
- âœ… **Validation**: Comprehensive pre-flight checks added
- âœ… **Remote server support**: PuTTY/SSH specific instructions

### New Features
- ðŸ†• **Automated setup**: `setup.sh` script for one-command installation
- ðŸ†• **Enhanced validation**: `--validate-only` flag for configuration checking
- ðŸ†• **Better error messages**: Clear guidance for fixing common issues
- ðŸ†• **Remote server focus**: Optimized for SSH/PuTTY users

## Important Notes

- All services use the unified project name "localai" for Docker Compose
- Supabase is started first, followed by other services with a 10-second delay
- SearXNG requires automatic secret key generation on first run
- The system supports both subdomain routing (service.domain.com) and path-based routing (domain.com/service)
- **New**: Enhanced validation prevents common Docker socket and permission errors
- **New**: Automated setup greatly simplifies remote server deployment
- No traditional package.json, requirements.txt, or Makefile - this is a Docker-orchestrated infrastructure project